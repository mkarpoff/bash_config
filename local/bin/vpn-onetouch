#!/usr/bin/env expect -f

# InfoSec consultation: https://t.corp.amazon.com/P33840651
# https://w.amazon.com/bin/view/ClientEng/Bravehearts/MacCheatCodes/
# USAGE: $vpn-onetouch $YUBIKEY_OTP

set my_user "$env(USER)"
set my_service amzn_vpn
set my_endpoint orca.amazon.com
#pdx-h-orca.amazon.com
set my_password [exec security find-generic-password -a $my_user -s $my_service -w]
if { $argc == 1 } {
	set my_yubikey  [lindex $argv 0]
} else {
	send_user -- "Press the button on your YubiKey (you might have to hold it for about 3-5 seconds before your token produces a one-time password)...\n"
	expect_user -re "(.*)\n"
	set my_yubikey "$expect_out(1,string)\r"
}
set timeout -1
spawn /opt/cisco/anyconnect/bin/vpn connect $my_endpoint
match_max 100000
expect -re "\r
Group: .*?"
send -- "orca-AmazonMacs\r"
expect -exact "\r
\r
Username: "
send -- "$my_user\r"
expect -exact "\r
Password: "
send -- "$my_password$my_yubikey\r"
expect eof
