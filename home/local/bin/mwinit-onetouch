#! /usr/bin/env expect

# USSAGE: $mwinit-onetouch
#
# If password isn't set:
#
#        keyring set midway <USERNAME>

set keyring "$env(HOME)/.local/bin/keyring"
set my_user "$env(USER)"
set my_service midway
set my_password [exec $keyring get $my_service $my_user]
set timeout -1
spawn /usr/bin/env mwinit -o
match_max 100000
expect -re "PIN for $my_user: "
send -- "$my_password\r"
expect -exact "\r
Press the button on your YubiKey (you might have to hold it for about 3-5 seconds before your token produces a one-time password)...\r"
expect_user -re "(.*)\n"
set my_yubikey "$expect_out(1,string)"
send -- "$my_yubikey\r"
expect -exact "\r
Now please wait a few seconds while the server processes your login request\r
Successfully authenticated using yubico otp, session cookie saved in /Users/$my_user/.midway/cookie\r
Successfully signed SSH public key /Users/$my_user/.ssh/id_rsa.pub. The SSH certificate saved in /Users/$my_user/.ssh/id_rsa-cert.pub\n"

